# プリプロセッサ

コンパイラが動作する前にソースコードに前処理を行うソフトウェア(プログラム)。前処理自体はプリプロセス、実行するプログラムがプリプロセッサという。

コンパイル作業をしやすくするためにソース・ファイルを加工する。

主に以下の3つの役割がある。

- インクルード処理
- マクロ処理
- コンパイル対象の条件分岐

# インクルード処理　#include
　
プリプロセッサが指定されたファイルを探し出し、#include命令が書かれた部分を置き換える。つまりincludeしたファイルの中身に置き換わる。

## ""と<>の違い

#includeには２種類ある。

```
#include <stdio.h>
#include "mylib.h"
```

- <>でくくるとコンパイラのインクルードパスで設定されたパスから探す。標準的なincludeファイルを読み込む
- ""はカレントディレクトリを探してから、次にコンパイラから探す。開発者が自作したincludeファイルはこちらでくくる。

自作したファイルを何もせずに読み込むならダブルクォーテーションを使うしかない。括弧では認識されない。
逆に括弧では自作ファイルを読み込むのも可能


# マクロ処理 　#define

ソースコード内の文字列を別の文字列に置換する。これを展開と呼ぶ。

```
#define PI 3.1415
//これは前処理時に該当箇所を置換してしまう。
```

## 定数との違いは？

定数と似ているのでは？。実際そう。この置換は`マクロ定数`とも呼ばれる。ただ定数はその後の再代入が不可。またマクロ処理は関数にも適応できる。そちらのが重要度がある。

しかし、型、構文チェックが働かない事もあるのでデバッグが困難になる。

## define 文字列1

主にプリプロセス時のフラグとして使われる。

挙動としては文字列を空文字列に置き換えている。

インクルードガードの処理に使われる。

ex)define.c

# 分岐処理

コードのコンパイルする部分を選択することが可能になる。


# インクルードガード

同じヘッダファイルを２回以上読み込まれる場合の影響をなくす。

以下のような目的もある。

- コンパイルの高速化
- includeディレクティブによる２つのファイルの相互インクルード防止

```
#ifndef XXXX //XXXXが定義されていなかったら

#define XXXX //XXXXを定義


#endif
```

# 構造体のアライメントとパディング

`ここからの内容はコンパイラやCPUによって左右される内容である。`

構造体を宣言した時の境界調節の事。意味が分からん？それもそう。

C言語ではsizeofで確保されているバイト数を見る事ができる。この時に構造体はメンバの合計値で構成されていると思いきやそうではない。

構造体memoryは`int,double,char,double`の順番にしている。

alignment.cの実行例

```
st = 32
st = memory(32)   0x7ffffff82690
st_i = int(4)     0x7ffffff82690
st_d = double(8)  0x7ffffff82698
st_c = char(1)    0x7ffffff826a0
st_d2 = double(8) 0x7ffffff826a8
```

構造体のメンバ変数の先頭アドレスを出力している。すると全ての感覚が8byte刻みで合計32byteの構造体になっている。

しかし、int型やchar型は本来4byteと1byteである。

つまり、単純計算では21byteになるはず。しかし実際は11byteも多い32byteになっている。

これは構造体にパディングを挿入して、アライメントを行っているからである。

どうやら、今回は8の倍数のアドレスに配置をされている。すると16進数では16に該当する表現は一週回って0なのでつじつまが合う。

つまり、int型では4バイトのパディングが発生している。

なので、構造体の順番を`double,double,int,char`に入れ替えた構造体nemoryでは構造体のサイズが24byteに減少している。

```
s = 24
s = memory(24)   0x7ffcb7ac9b30
s_d = double(8)  0x7ffcb7ac9b30
s_d2 = double(8) 0x7ffcb7ac9b38
s_i = int(4)     0x7ffcb7ac9b40
s_c = char(1)    0x7ffcb7ac9b44
```

# メモリアライメント

メモリアドレス番地の位置の事を指している。これを守る事でバグを減らす事ができる。

- ワードアクセス
- ハーフアクセス
- バイトアクセス

これを守らないとアライメント違反になり、守る為にアライメントを調節する。

## CPUのメモリアクセス

CPUはメモリアクセスするとき、アドレス番地とデータサイズの組み合わせで得意、不得意が存在する。これを一致させておくとメモリの読み書きがその分早くなる。

# パディング

アライメントを守るためにメモリにそれぞれbyteを入れる事。

